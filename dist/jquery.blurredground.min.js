/*

BlurredGround 0.1-alpha
Real time blurred background from full-height page canvas by @wdmg
https://github.com/wdmg/blurredground

*/

(function(){"use strict";var t,o;t=jQuery,o=function(o,n){var o;return this.options=t.extend({localStorage:!0,cacheTime:86400,background:"#ffffff",blurring:!0,blurringRadius:64,offsetX:0,offsetY:0,opacity:1,lighten:.5,logging:!1},t.fn.blurredGround.defaults,n||{}),this.element=o,this.$element=t(o),"function"!=typeof html2canvas?void console.warn('"Html2canvas" plugin is not found or was not init first!'):"function"!=typeof stackBlurImage?void console.warn('"StackBlur" plugin is not found or was not init first!'):this.init()},o.prototype={getUrlHash:function(t){return t.split("").reduce(function(t,o){return t=(t<<5)-t+o.charCodeAt(0),t&t},0)},attachBackground:function(t){this.blurredCanvas=t,this.$element.css("background","url("+this.blurredCanvas+") center top no-repeat"),this.$element.show(),this.options.logging&&console.log("Attach background to element.")},bindScrolling:function(){t(window).scroll(function(){var o=-t(window).scrollTop();t("body > nav").css("background-position","center "+o+"px")})},getPageSizes:function(){var t=document.body,o=document.documentElement,n=Math.max(t.scrollWidth,t.offsetWidth,o.clientWidth,o.scrollWidth,o.offsetWidth),e=Math.max(t.scrollHeight,t.offsetHeight,o.clientHeight,o.scrollHeight,o.offsetHeight);return this.options.logging&&console.log("Get full-page sizes, width: "+n+"px, height: "+e),{width:n,height:e}},lightenBg:function(t,o){for(var n,e,i,a=t.getContext("2d"),s=a.getImageData(0,0,t.width,t.height),g=s.data,l=g.length,r=0;l>r;r+=4)n=g[r],e=g[r+1],i=g[r+2],g[r]=n+n*(n/255)*o,g[r+1]=e+e*(e/255)*o,g[r+2]=i+i*(i/255)*o;a.putImageData(s,0,0)},toLocalStorage:function(t){var o={value:t,timestamp:(new Date).getTime()};localStorage.setItem(this.canvasId,JSON.stringify(o))},generateBackground:function(){t("body").scrollTop(0);var o=this.getPageSizes();this.options.logging&&console.log("Generate full-page canvas (html2canvas)");var o=o,n=(new Date).getTime(),e=this;html2canvas(t("body"),{onrendered:function(i){var a=e,s=o;a.options.logging&&console.log('Create temporary canvas "#'+a.canvasId+'".');var g=document.createElement("canvas");g.id=a.canvasId,t("canvas#"+a.canvasId).addClass("hide"),document.body.appendChild(g),g.width=s.width,g.height=s.height,a.options.logging&&console.log('Set canvas offset x: "'+a.options.offsetX+'", y: "'+a.options.offsetY+'".'),g.style.left=a.options.offsetX+"px",g.style.top=a.options.offsetY+"px",a.options.opacity>0&&(a.options.logging&&console.log('Set opacity canvas with "'+a.options.opacity+'" koef.'),g.globalAlpha=a.options.opacity);var l=g.getContext("2d");l.drawImage(i,a.options.offsetX,a.options.offsetY,s.width,s.height,0,0,s.width,s.height),l.fillStyle=a.options.background,a.options.lighten>0&&(a.options.logging&&console.log('Process lighten canvas with "'+a.options.lighten+'" koef.'),a.lightenBg(g,a.options.lighten)),a.options.blurring&&a.options.blurringRadius>0&&(a.options.logging&&console.log('Process blurring canvas with "'+a.options.blurringRadius+'" blurring radius.'),stackBlurCanvasRGBA(a.canvasId,a.options.offsetX,a.options.offsetY,o.width,o.height,a.options.blurringRadius)),a.blurredCanvas=g.toDataURL("image/png"),a.attachBackground(a.blurredCanvas),a.toLocalStorage(a.blurredCanvas),a.bindScrolling(),a.options.logging&&console.log('Remove temporary canvas "#'+a.canvasId+'" from document.'),t("canvas#"+a.canvasId).remove();var r=(new Date).getTime();a.options.logging&&console.log("Generation complete, it took time: "+(r-n)/1e3+" sec.")},background:this.options.background,width:o.width,height:o.height})},init:function(){this.$element.css("background",this.options.background);var o=this.getUrlHash(document.location.href);if(this.options.logging&&console.log("Current location href hash: "+o),this.options.localStorage&&"undefined"!=typeof Storage){this.options.logging&&console.log("Web local storage support!"),this.canvasId="ocanvas"+o,this.options.logging&&console.log("Page canvas indefier in localStorage: "+this.canvasId);var n,e=JSON.parse(localStorage.getItem(this.canvasId)),i=(new Date).getTime();return t.isEmptyObject(e)?this.options.logging&&console.log('Canvas timestamp "'+this.canvasId+'" is empty in localStorage.'):n=e.timestamp,n=parseInt(n/1e3),i=parseInt(i/1e3),this.options.logging&&console.log('Current time: "'+i+'", timestamp: "'+n+'", cache time "'+this.options.cacheTime+'".'),parseInt(i-n)<=parseInt(this.options.cacheTime)?(this.options.logging&&console.log("Get canvas object from localStorage and attach to background element."),this.attachBackground(e.value),void this.bindScrolling()):(this.options.logging&&console.log("Generate new canvas background (cache is outdated)."),void this.generateBackground())}}},t.fn.blurredGround=function(n){return this.each(function(){var e;return e=t(this),n=t.extend({localStorage:!0,cacheTime:86400,blurring:!0,blurringRadius:64,background:"#ffffff",offsetX:0,offsetY:0,opacity:1,lighten:.5,logging:!1},n,e.data()),new o(this,n),this})},t.fn.blurredGround.defaults={localStorage:!0,cacheTime:86400,blurring:!0,blurringRadius:64,background:"#ffffff",offsetX:0,offsetY:0,opacity:1,lighten:.5,logging:!1}}).call(this);
