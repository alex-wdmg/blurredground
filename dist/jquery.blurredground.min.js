/*

BlurredGround 0.2
Real time blurred background from full-height page canvas by @wdmg
https://github.com/wdmg/blurredground

Author: Alexsander Vyshyvetskyy
Contact: alex.vyshnyvetskyy@gmail.com
License: https://github.com/wdmg/blurredground/blob/master/LICENSE.md
Copyright (c) 2016 Alexsander Vyshyvetskyy (W.D.M.Group, Ukraine)

*/
(function(){"use strict";var t,e;t=jQuery,e=function(e,n){var e;return this.options=t.extend({localStorage:!0,cacheTime:86400,background:"#ffffff",processor:"StackBlur",blurring:!0,blurringRadius:64,offsetX:0,offsetY:0,opacity:1,compress:1,lighten:.5,logging:!1},t.fn.blurredGround.defaults,n||{}),this.startTime=Date.now(),this.element=e,this.$element=t(e),"function"!=typeof html2canvas?void console.warn('"Html2canvas" plugin is not found or was not init first!'):"function"!=typeof stackBlurImage&&"StackBlur"==this.options.processor?void console.warn('"StackBlur" plugin is not found or was not init first!'):"function"!=typeof RTBlur&&"RTBlur"==this.options.processor?void console.warn('"RTBlur" plugin is not found or was not init first!'):this.init()},e.prototype={getUrlHash:function(t){return t.split("").reduce(function(t,e){return t=(t<<5)-t+e.charCodeAt(0),t&t},0)},attachBackground:function(e){this.setSourceCanvas(e),this.$element.css("background",this.options.background+" url("+this.blurredCanvas+") center top no-repeat"),this.$element.show(),t(this).data("canvas",this.blurredCanvas)},getSourceCanvas:function(){return this.blurredCanvas},setSourceCanvas:function(t){return this.blurredCanvas=t,this.blurredCanvas},bindScrolling:function(){var e=this.$element;t(window).scroll(function(){var n=-t(window).scrollTop();e.css("background-position","center "+n+"px")})},getPageSizes:function(){var t=document.body,e=document.documentElement,n=Math.max(t.scrollWidth,t.offsetWidth,e.clientWidth,e.scrollWidth,e.offsetWidth),o=Math.max(t.scrollHeight,t.offsetHeight,e.clientHeight,e.scrollHeight,e.offsetHeight);return{width:n,height:o}},lightenBg:function(t,e){if(e>0&&t){for(var n,o,a,i=t.getContext("2d"),r=i.getImageData(0,0,t.width,t.height),s=r.data,l=s.length,c=0;l>c;c+=4)n=s[c],o=s[c+1],a=s[c+2],s[c]=n+n*(n/255)*e,s[c+1]=o+o*(o/255)*e,s[c+2]=a+a*(a/255)*e;i.putImageData(r,0,0)}return t},isLocalStorageSupport:function(t){var e=this;try{return window.localStorage.setItem(t,"1"),window.localStorage.removeItem(t),localStorageName in win&&win[localStorageName]}catch(n){return e.options.localStorage=!1,!1}},toLocalStorage:function(t){if(this.isLocalStorageSupport(this.canvasId)){var e={value:t,timestamp:(new Date).getTime()};window.localStorage.setItem(this.canvasId,JSON.stringify(e))}},getImageDataUri:function(t){var e=new Image;return e.src=t,e.onload=function(){var t=document.createElement("canvas");return t.width=this.naturalWidth,t.height=this.naturalHeight,t.getContext("2d").drawImage(this,0,0),t.toDataURL("image/png")},t},compressCanvas:function(t){var e=this;return e.options.compress<1?t.toDataURL("image/jpeg",+e.options.compress):t.toDataURL("image/png")},getCanvas:function(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,n},getPixels:function(t){var e,n,o=this;if(t.getContext){e=t;try{n=e.getContext("2d")}catch(a){}}return n||(e=o.getCanvas(t.width,t.height),n=e.getContext("2d"),n.drawImage(t,0,0)),n.getImageData(0,0,e.width,e.height)},filterImage:function(t,e,n){for(var o=this,a=[o.getPixels(e)],i=2;i<arguments.length;i++)a.push(arguments[i]);return t.apply(null,a)},convolute:function(t,e,n){for(var o=Math.round(Math.sqrt(e.length)),a=Math.floor(o/2),i=t.data,r=t.width,s=t.height,l=r,c=s,h=document.createElement("canvas"),u=h.getContext("2d"),g=u.createImageData(l,c),d=g.data,f=n?1:0,p=0;c>p;p++)for(var m=0;l>m;m++){for(var v=p,w=m,b=4*(p*l+m),S=0,I=0,C=0,k=0,y=0;o>y;y++)for(var R=0;o>R;R++){var B=Math.min(s-1,Math.max(0,v+y-a)),x=Math.min(r-1,Math.max(0,w+R-a)),T=4*(B*r+x),D=e[y*o+R];S+=i[T]*D,I+=i[T+1]*D,C+=i[T+2]*D,k+=i[T+3]*D}d[b]=S,d[b+1]=I,d[b+2]=C,d[b+3]=k+f*(255-k)}return g},blurFilter:function(t,e,n){var o=document.getElementById(t),a=this.filterImage(e,o,n);o.width=a.width,o.height=a.height;var i=o.getContext("2d");return i.putImageData(a,0,0),o},generateBackground:function(){t("body").scrollTop(0);this.options.before.call(this);var e=this.getPageSizes(),n=((new Date).getTime(),this);return html2canvas(t("body"),{onrendered:function(o){var a=n,i=e,r=document.createElement("canvas");r.id=a.canvasId,t("canvas#"+a.canvasId).addClass("hide"),document.body.appendChild(r),r.width=i.width,r.height=i.height,r.style.left=a.options.offsetX+"px",r.style.top=a.options.offsetY+"px";var s=r.getContext("2d");if(s.imageSmoothingEnabled=!1,a.options.opacity>0&&(s.globalAlpha=a.options.opacity),s.drawImage(o,a.options.offsetX,a.options.offsetY,i.width,i.height,0,0,i.width,i.height),s.fillStyle=a.options.background,a.options.lighten>0&&0!=a.options.lighten&&(r=a.lightenBg(r,a.options.lighten)),a.options.blurring&&a.options.blurringRadius>0){var l=!1;if("StackBlur"==a.options.processor)a.options.opacity<1?stackBlurCanvasRGBA(a.canvasId,a.options.offsetX,a.options.offsetY,e.width,e.height,a.options.blurringRadius):stackBlurCanvasRGB(a.canvasId,a.options.offsetX,a.options.offsetY,e.width,e.height,a.options.blurringRadius);else if("RTBlur"==a.options.processor){var c=new RTBlur({source:r,quality:4,HQ:!0}),h=5.5*a.options.blurringRadius;null!==c&&c.blur(h,s)}else{l=!0;var u='<svg xmlns="http://www.w3.org/2000/svg" width="'+o.width+'" height="'+o.height+'"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml"><img src="'+o.toDataURL("image/png")+'" style="display:block;-webkit-filter:blur('+a.options.blurringRadius+"px);filter:blur("+a.options.blurringRadius+'px);" width="'+o.width+'" height="'+o.height+'" /></div></foreignObject></svg>',g=window.URL||window.webkitURL||window,d=new Image,f=new Blob([u],{type:"image/svg+xml;charset=utf-8"}),p=g.createObjectURL(f);d.onload=function(){g.revokeObjectURL(p)},d.src=p;var m=new XMLHttpRequest;m.responseType="blob",m.onload=function(){var t=new FileReader;t.onloadend=function(){a.blurredCanvas=t.result,a.options.localStorage&&a.toLocalStorage(a.blurredCanvas)},t.readAsDataURL(m.response)},m.open("GET",p),m.send(null),a.blurredCanvas=d.src}}l||(a.blurredCanvas=a.compressCanvas(r),a.options.localStorage&&a.toLocalStorage(a.blurredCanvas)),a.attachBackground(a.blurredCanvas),a.bindScrolling(),t("canvas#"+a.canvasId).remove(),a.options.after.call(this)},background:this.options.background,useBounds:!1,letterRendering:!0,useCORS:!0,width:e.width,height:e.height,logging:this.options.logging?!0:!1}),this},init:function(){this.$element.css("background",this.options.background);var e=this.getUrlHash(document.location.href);if(this.options.localStorage&&"undefined"!=typeof Storage){this.canvasId="ocanvas"+e;var n,o=JSON.parse(window.localStorage.getItem(this.canvasId)),a=(new Date).getTime();return t.isEmptyObject(o)||(n=o.timestamp),n=parseInt(n/1e3),a=parseInt(a/1e3),parseInt(a-n)<=parseInt(this.options.cacheTime)?(this.options.before.call(this),this.attachBackground(o.value),this.bindScrolling(),this.options.after.call(this),this):(this.generateBackground(),this)}return this.generateBackground(),this}},t.fn.blurredGround=function(n){return this.each(function(){var o;return o=t(this),n=t.extend({localStorage:!0,cacheTime:86400,processor:"StackBlur",blurring:!0,blurringRadius:64,background:"#ffffff",offsetX:0,offsetY:0,opacity:1,compress:1,lighten:.5,logging:!1,before:function(){},after:function(){}},n,o.data()),new e(this,n),this})},t.fn.blurredGround.defaults={localStorage:!0,cacheTime:86400,processor:"StackBlur",blurring:!0,blurringRadius:64,background:"#ffffff",offsetX:0,offsetY:0,opacity:1,compress:1,lighten:.5,logging:!1,before:function(){},after:function(){}}}).call(this);